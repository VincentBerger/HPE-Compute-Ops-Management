# Telegraf/Influxdb/Grafana for HPE Compute Ops Management sustainability data

The combination of Telegraf, InfluxDB, and Grafana forms a powerful toolset for collecting, storing, and visualizing HPE Compute Ops Management sustainability data. 

- **Telegraf**: Telegraf acts as the collection agent, responsible for collecting sustainability data from HPE Compute Ops Management. Telegraf allows you to configure which metrics to collect, how frequently to collect them, and where to send the data. 

- **InfluxDB**: InfluxDB is a high-performance time-series database that specializes in storing and retrieving time-stamped data. It provides efficient storage mechanisms for handling large volumes of metrics data. Telegraf sends the collected metrics to InfluxDB, where they are stored and indexed based on time. InfluxDB also offers advanced querying capabilities, allowing you to perform complex queries, aggregations, and filtering operations on the data.

- **Grafana**: Grafana is a popular open-source platform used for visualization and monitoring. It connects to InfluxDB (and other data sources) and allows you to create rich, interactive dashboards to visualize your metrics data. With Grafana, you can build custom visualizations and charts, set up alerts and notifications based on metric thresholds, and share dashboards with others.   
       
![image](https://user-images.githubusercontent.com/13134334/204873169-6ca5393a-d98a-4d67-81b4-e439b4a3a507.png)

This solution allows you to monitor the HPE Compute Ops Management system consumptions, carbon emissions and energy cost and identify trends, and make data-driven decisions.

> Note: The metrics visualization can go beyond the current 7-day limit of HPE Compute Ops Management as all data is stored in InfluxDB. 


## Requirements

- Telegraf
- Influxdb (with an admin account for telegraf)
- Grafana configured with an InfluxDB data source
- Powershell on Linux, version 7 and later, see https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-linux?view=powershell-7.3
- HPE Compute Ops Management API Client Credentials. To learn more about how to set up the API client credentials, see https://support.hpe.com/hpesc/public/docDisplay?docId=a00120892en_us 


## Intallation of Telegraf, InfluxDB and Grafana

For the installation steps of the TIG stack ecosystem on Rocky Linux 9.3, you can refer to [Installation steps of the TIG stack ecosystem](https://github.com/jullienl/HPE-Compute-Ops-Management/blob/main/Grafana-InfluxDB-Telegraf/Installation%20steps%20of%20the%20TIG%20stack%20ecosystem.md)


## Telegraf/Exec script for collecting sustainability data from HPE Compute Ops Management. 

In order to gather sustainability data from HPE Compute Ops Management, you can use the PowerShell script `COM-telegraf-Sustainability-collector.ps1`. This script needs to be executed periodically using the Exec plugin in Telegraf. 

> More information about the Exec input plugin can be found at https://github.com/influxdata/telegraf/tree/master/plugins/inputs/exec 

By running this script, you will be able to collect the sustainability metrics available from HPE Compute Ops Management. They currently include:
 - The carbon emissions (in kgCO2e)
 - The energy consumption (in kWh) 
 - The energy cost (in USD)

For each of these, two measurements are available, one for the total value per week and one for the total value per day.

`COM-telegraf-Sustainability-collector.ps1` first generates an HPE Compute Ops Management sustainability report to collect the metrics data from the cloud platform. This is a prerequisite for obtaining sustainability data. Once the sustainability report is complete, the script converts the report data to the InfluxDB Line Protocol format, which is used by Telegraf to ingest data into InfluxDB. Grafana can then use InfluxDB data to create rich, interactive dashboards for visualizing HPE Compute Ops Management metrics.

**Note**: On Linux systems, official packages by default configure Telegraf to operate under the `telegraf` user and group. To guarantee that Telegraf has the necessary read and execute permissions for the PowerShell script while it runs with the `telegraf` user and group credentials, you might need to adjust the file permissions and ownership of the PowerShell script accordingly.


Example of output generated by the script:
```
COM_Sustainability_Total_Report TotalCarbonEmissionsPerDay=145.89
COM_Sustainability_Total_Report TotalCarbonEmissionsPerWeek=870.66
COM_Sustainability_Total_Report TotalEnergyConsumptionPerDay=330.62
COM_Sustainability_Total_Report TotalEnergyConsumptionPerWeek=1973.1
COM_Sustainability_Total_Report TotalEnergyCostPerDay=52.9
COM_Sustainability_Total_Report TotalEnergyCostPerWeek=315.7
COM_Sustainability_Individual_Report 2M282501KR_TotalEnergyConsumptionPerWeek=3.19
COM_Sustainability_Individual_Report 2M282501KR_TotalEnergyConsumptionPerDay=3.19
COM_Sustainability_Individual_Report 2M282501KR_TotalCarbonEmissionsPerWeek=1.41
COM_Sustainability_Individual_Report 2M282501KR_TotalCarbonEmissionsPerDay=1.41
COM_Sustainability_Individual_Report 2M282501KR_TotalEnergyCostPerWeek=0.51
COM_Sustainability_Individual_Report 2M282501KR_TotalEnergyCostPerDay=0.51
COM_Sustainability_Individual_Report 2M293800KC_TotalCarbonEmissionsPerWeek=2.3
COM_Sustainability_Individual_Report 2M293800KC_TotalCarbonEmissionsPerDay=0.41
COM_Sustainability_Individual_Report 2M293800KC_TotalEnergyConsumptionPerWeek=5.21
COM_Sustainability_Individual_Report 2M293800KC_TotalEnergyConsumptionPerDay=0.92
COM_Sustainability_Individual_Report 2M293800KC_TotalEnergyCostPerWeek=0.83
COM_Sustainability_Individual_Report 2M293800KC_TotalEnergyCostPerDay=0.15
COM_Sustainability_Individual_Report 2M2946009Z_TotalCarbonEmissionsPerWeek=0.4
COM_Sustainability_Individual_Report 2M2946009Z_TotalCarbonEmissionsPerDay=0.4
COM_Sustainability_Individual_Report 2M2946009Z_TotalEnergyConsumptionPerWeek=0.9
COM_Sustainability_Individual_Report 2M2946009Z_TotalEnergyConsumptionPerDay=0.9
COM_Sustainability_Individual_Report 2M2946009Z_TotalEnergyCostPerWeek=0.14
COM_Sustainability_Individual_Report 2M2946009Z_TotalEnergyCostPerDay=0.14
```

## Telegraf configuration 

Example of a Telegraf configuration running the PowerShell script every day with a 500-second timeout:

File: `/etc/telegraf/HPE_COM.conf`


```
[[outputs.influxdb]]
  database = "telegraf"
  ## HTTP Basic Auth
  username = "telegraf"
  password = "xxxxxxxxxxxxxxx"

[[inputs.exec]]
  commands = ["pwsh <path>/COM-telegraf-Sustainability-collector.ps1"] 
  interval = "24h" 
  timeout = "500s"
  data_format = "influx"

```

**Note**: To get the PowerShell path, use `which pwsh`


## Grafana configuration

### Add InfluxDB data source 

To add a Grafana data source for InfluxDB, follow these steps:

1. Open your Grafana web interface and log in.
2. Click on the toggle menu and select **Administration** then **Plugins**
4. On the Plugins page, search for **InfluxDB** and click on it.
6. Then click on **Add new data source** and fill in the following information:
   - **URL**: Enter the base URL of your InfluxDB instance (e.g., http://localhost:8086).
   - **Auth**: Select the appropriate authentication parameters for your data source.
   - **Database**: Specify the name of the InfluxDB database you want to connect to (e.g., "telegraf" as defined in `/etc/telegraf/HPE_COM.conf` ).
   - **User**: If authentication is enabled, enter the username (e.g., "telegraf" as configured in InfluxDB and defined in `/etc/telegraf/HPE_COM.conf`).
   - **Password**: If authentication is enabled, enter the password (e.g., "xxxxxxxxxxxxxxx" as configured in InfluxDB and defined in `/etc/telegraf/HPE_COM.conf`).
   - **HTTP Method**: Select the appropriate HTTP method for your InfluxDB instance.
7. Once you have filled in the required fields, click on the **Save & Test** button.


### Grafana panels for total sustainability report

To quickly set up a Grafana dashboard showing the total sustainability data collected by the PowerShell script, you can import a preconfigured dashboard using the [HPE COM sustainability report (TIG stack with PowerShell script)-1708941917817](https://github.com/jullienl/HPE-Compute-Ops-Management/blob/main/Grafana-InfluxDB-Telegraf/HPE%20COM%20sustainability%20report%20(TIG%20stack%20with%20PowerShell%20script)-1708941917817.json) JSON file. 


Or manually, you can use:

Data source: `Influxdb`

FROM: `COM_Sustainability_Total_Report`

SELECT:   
  `field(TotalCarbonEmissionsPerDay)` with ALIAS: `Carbon Emissions (kgCO2e)`   
  or   
  `field(TotalCarbonEmissionsPerWeek)` with ALIAS: `Carbon Emissions (kgCO2e)`   
  or   
  `field(TotalEnergyConsumptionPerDay)` with ALIAS: `Energy consumption (kWh)`   
  or   
  `field(TotalEnergyConsumptionPerWeek)` with ALIAS: `Energy consumption (kWh)`   
  or   
  `field(TotalEnergyCostPerDay)` with ALIAS: `Energy cost (USD)`   
  or   
  `field(TotalEnergyCostPerWeek)` with ALIAS:  `Energy cost (USD)`   



## Grafana panels for individual sustainability report

Data source: `Influxdb`

FROM: `COM_Sustainability_Individual_Report`

SELECT:   
  `field(serverName_TotalCarbonEmissionsPerWeek)` with ALIAS: `Carbon Emissions (kgCO2e)`   
  or   
  `field(serverName_TotalCarbonEmissionsPerWeek)` with ALIAS: `Carbon Emissions (kgCO2e)`   
  or   
  `field(serverName_TotalEnergyConsumptionPerDay)` with ALIAS: `Energy consumption (kWh)`   
  or   
  `field(serverName_TotalEnergyConsumptionPerWeek)` with ALIAS: `Energy consumption (kWh)`   
  or   
  `field(serverName_TotalEnergyCostPerDay)` with ALIAS: `Energy cost (USD)`   
  or   
  `field(serverName_TotalEnergyCostPerWeek)` with ALIAS:  `Energy cost (USD)`   


## Example of a Grafana panel 

Example of a Grafana panel with a Telegraf agent interval = 1d for all and individual servers:

![image](https://github.com/jullienl/HPE-Compute-Ops-Management/assets/13134334/8ce4d10c-7599-42a0-8f2c-2ac576a045f4)



